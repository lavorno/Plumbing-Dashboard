{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Top Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-dark text-white h-100">
                <div class="card-body">
                    <h6 class="card-title text-purple">Billable Hours</h6>
                    <h3 class="card-text"><span id="billable-hours">0</span></h3>
                    <small class="text-muted text-animate">hours per month</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white h-100">
                <div class="card-body">
                    <h6 class="card-title text-purple">Hourly Rate</h6>
                    <div class="rate-container">
                        <div class="current-rate">
                            <h3 class="card-text">$<span id="hourly-rate">0.00</span></h3>
                            <button id="rate-lock-btn" class="btn btn-sm btn-outline-purple">
                                <i class="fas fa-lock-open"></i>
                            </button>
                        </div>
                        <div class="recommended-rate">
                            <small class="text-muted text-animate">Recommended: $<span id="recommended-rate">0.00</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white h-100">
                <div class="card-body">
                    <h6 class="card-title text-purple">Cost Per Hour</h6>
                    <h3 class="card-text">$<span id="cost-per-hour">0.00</span></h3>
                    <small class="text-muted text-animate">per billable hour</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-dark text-white h-100">
                <div class="card-body">
                    <h6 class="card-title text-purple">Total Expenses</h6>
                    <h3 class="card-text">$<span id="total-expenses">0.00</span></h3>
                    <small class="text-muted text-animate">monthly expenses</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue and Profit Cards -->
    <div class="row mb-4">
        <!-- Monthly Revenue and Profit -->
        <div class="col-md-6">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h5 class="card-title text-purple">Monthly Projections</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">Revenue Potential</h6>
                                <h3 class="text-success">$<span id="monthly-revenue">0.00</span></h3>
                                <small class="text-muted text-animate">projected monthly</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">Profit Potential</h6>
                                <h3 class="text-success">$<span id="monthly-profit">0.00</span></h3>
                                <small class="text-muted text-animate">Margin: <span id="monthly-margin">0.00</span>%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Yearly Revenue and Profit -->
        <div class="col-md-6">
            <div class="card bg-dark text-white">
                <div class="card-body">
                    <h5 class="card-title text-purple">Yearly Projections</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">Revenue Potential</h6>
                                <h3 class="text-success">$<span id="yearly-revenue">0.00</span></h3>
                                <small class="text-muted text-animate">projected yearly</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6 class="text-muted">Profit Potential</h6>
                                <h3 class="text-success">$<span id="yearly-profit">0.00</span></h3>
                                <small class="text-muted text-animate">Margin: <span id="yearly-margin">0.00</span>%</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Business Details -->
    <div class="row flex-grow-1">
        <!-- Monthly Expenses -->
        <div class="col-md-6">
            <div class="card bg-dark text-white dashboard-card monthly-expenses">
                <div class="card-body">
                    <h5 class="card-title text-purple mb-3">Monthly Expenses</h5>
                    <div class="d-flex justify-content-end mb-2">
                        <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="sortExpenses('name')">
                            <i class="fas fa-sort-alpha-down"></i> Sort by Name
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="sortExpenses('amount')">
                            <i class="fas fa-sort-numeric-down"></i> Sort by Amount
                        </button>
                    </div>
                    <div class="expenses-table-container">
                        <div class="table-responsive">
                            <table class="table table-dark">
                                <tbody id="expenses-list">
                                    <!-- Expenses will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="expenses-total">
                            <table class="table table-dark mb-0">
                                <tbody>
                                    <tr class="text-purple">
                                        <td><strong>Total Monthly Expenses</strong></td>
                                        <td class="text-end"><strong id="expenses-total-value">$0.00</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Service Trucks -->
        <div class="col-md-6">
            <div class="card bg-dark text-white dashboard-card service-trucks">
                <div class="card-body">
                    <h5 class="card-title text-purple mb-3">Service Trucks</h5>
                    <div class="trucks-container">
                        <div id="trucks-overview">
                            <!-- Trucks will be populated here -->
                        </div>
                        <div class="trucks-summary">
                            <div class="summary-item">
                                <span class="summary-label">Total Team Size</span>
                                <span class="summary-value" id="total-employees">0 employees</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Weekly Hours</span>
                                <span class="summary-value" id="total-hours">0 hrs</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Monthly Expenses</span>
                                <span class="summary-value" id="total-truck-expenses">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add business parameters sidebar -->
    <div class="business-parameters-sidebar">
        <h6>BUSINESS PARAMETERS</h6>
        <div class="param-item">
            <div class="param-label">Efficiency Rate</div>
            <div class="param-control">
                <div class="slider-container">
                    <input type="range" 
                           id="efficiency-rate-input" 
                           min="0" 
                           max="100" 
                           step="5"
                           class="custom-slider"
                           oninput="handleSliderInput(this, 'efficiency_rate', value => value / 100)"
                           onchange="handleSliderRelease(this, 'efficiency_rate', value => value / 100)"
                           value="0">
                </div>
                <div class="param-display">0%</div>
            </div>
        </div>
        <div class="param-item">
            <div class="param-label">Profit Margin</div>
            <div class="param-control">
                <div class="slider-container">
                    <input type="range" 
                           id="profit-margin-input" 
                           min="0" 
                           max="100" 
                           step="5"
                           class="custom-slider"
                           oninput="handleSliderInput(this, 'profit_margin_multiplier', value => (100 - value) / 100)"
                           onchange="handleSliderRelease(this, 'profit_margin_multiplier', value => (100 - value) / 100)"
                           value="0">
                </div>
                <div class="param-display">0%</div>
            </div>
        </div>
        <div class="param-item">
            <div class="param-label">Hourly Rate</div>
            <div class="param-control">
                <div class="slider-container">
                    <input type="range" 
                           id="hourlyRateSlider" 
                           min="100" 
                           max="500" 
                           step="5"
                           class="custom-slider"
                           oninput="handleHourlyRateSlider(this)"
                           onchange="handleHourlyRateRelease(this)"
                           value="285">
                </div>
                <div class="param-display-container">
                    <div class="param-display">$285</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding-bottom: 1rem;
    position: relative;
}

.dashboard-card {
    height: calc(100vh - 420px);
    min-height: 400px;
    display: flex;
    flex-direction: column;
}

.dashboard-card .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.flex-grow-1 {
    flex-grow: 1;
}

/* Specific table responsive settings */
.monthly-expenses .table-responsive,
.service-trucks .table-responsive {
    overflow-y: auto;
    height: calc(100% - 120px);
    min-height: 200px;
}

.service-trucks {
    height: calc(100vh - 420px);
    min-height: 400px;
}

.card {
    margin-bottom: 0;
}

.debug-icon {
    bottom: 1rem;
}

.expenses-table-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-top: 1rem;
}

.expenses-table-container .table-responsive {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    border-bottom: 1px solid rgba(167, 139, 250, 0.2);
}

.expenses-total {
    background: var(--dark-bg);
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    margin-top: auto;
    padding: 8px 0;
}

.expenses-total .table {
    margin-bottom: 0;
}

.btn-outline-primary {
    color: #a78bfa;
    border: 1px solid rgba(167, 139, 250, 0.3);
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-outline-primary:hover {
    background: rgba(167, 139, 250, 0.1);
    color: #c4b5fd;
    border-color: rgba(167, 139, 250, 0.5);
}

.service-trucks .card-body {
    padding-bottom: 16px;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.service-trucks .table-responsive {
    flex-grow: 1;
    overflow-y: auto;
}

/* Business parameters sidebar styles */
.business-parameters-sidebar {
    position: fixed;
    right: calc(((100vw - 1320px) / 2) - 265px);
    top: 80px;
    background: rgba(17, 24, 39, 0.95);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(167, 139, 250, 0.2);
    padding: 1.5rem;
    width: 240px;
    border-radius: 8px;
    z-index: 1000;
}

.business-parameters-sidebar h6 {
    color: #a78bfa;
    font-size: 0.75rem;
    margin-bottom: 1.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    text-align: center;
    font-weight: 600;
}

.business-parameters-sidebar .param-item {
    margin-bottom: 1.25rem;
}

.business-parameters-sidebar .param-item:last-child {
    margin-bottom: 0;
}

.business-parameters-sidebar .param-label {
    color: #9CA3AF;
    font-size: 0.75rem;
    margin-bottom: 0.5rem;
    text-align: center;
}

.business-parameters-sidebar .param-control {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
    width: 100%;
}

.business-parameters-sidebar .form-control {
    background: rgba(17, 24, 39, 0.5);
    border: 1px solid rgba(167, 139, 250, 0.2);
    color: white;
    width: 80px;
    height: 32px;
    padding: 0.25rem;
    text-align: center;
    font-size: 1rem;
    border-radius: 4px;
}

.business-parameters-sidebar .form-control:focus {
    background: rgba(17, 24, 39, 0.7);
    border-color: rgba(167, 139, 250, 0.5);
    box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.25);
    color: white;
    outline: none;
}

.business-parameters-sidebar .form-control::-webkit-inner-spin-button,
.business-parameters-sidebar .form-control::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.business-parameters-sidebar .form-control[type=number] {
    -moz-appearance: textfield;
    appearance: textfield;
}

.business-parameters-sidebar .param-display {
    color: #a78bfa;
    font-size: 1.25rem;
    font-weight: 500;
    min-height: 1.5rem;
}

.trucks-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin-top: 1rem;
    padding: 0 0.5rem;
}

#trucks-overview {
    flex: 1;
    overflow-y: auto;
    min-height: 0;
    margin: 0 -0.5rem;
    padding: 0 1rem 0.5rem 0.5rem;
    max-height: calc(100% - 60px);
}

.truck-card {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.truck-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.truck-title {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.truck-name {
    font-size: 1.1rem;
    font-weight: 500;
    color: #a78bfa;
}

.truck-details {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.truck-model {
    font-size: 0.8rem;
    color: #e2e8f0;
}

.truck-plate {
    font-size: 0.8rem;
    color: #9CA3AF;
    font-family: monospace;
    background: rgba(17, 24, 39, 0.5);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.truck-hours {
    font-size: 0.9rem;
    color: #9CA3AF;
    align-self: flex-start;
}

.truck-team {
    font-size: 0.9rem;
    color: #e2e8f0;
    margin-bottom: 0.75rem;
}

.truck-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin: 1rem -0.5rem;
    padding: 0 0.5rem;
}

.metric-item {
    background: rgba(17, 24, 39, 0.5);
    padding: 0.75rem;
    border-radius: 6px;
    border: 1px solid rgba(167, 139, 250, 0.2);
    text-align: center;
    min-width: 0;
}

.metric-item.revenue {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.metric-item.profit {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.25);
}

.metric-item.revenue .metric-value,
.metric-item.profit .metric-value {
    color: #10B981;
    font-weight: 500;
}

.metric-label {
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-bottom: 0.25rem;
}

.trucks-summary {
    background: rgba(17, 24, 39, 0.8);
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    padding: 0.5rem;
    margin: 0 -0.5rem;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    height: 60px;
}

.summary-item {
    background: rgba(17, 24, 39, 0.5);
    padding: 0.35rem;
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.2);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.summary-label {
    font-size: 0.65rem;
    color: #9CA3AF;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.summary-value {
    color: #e2e8f0;
    font-size: 0.85rem;
    font-weight: 500;
}

/* Animation styles */
.number-transition {
    position: relative;
    display: inline-block;
    min-width: 60px;
    text-align: right;
}

.number-transition.changing::after {
    content: attr(data-value);
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    opacity: 0;
    animation: numberFadeIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

.number-transition.changing::before {
    content: attr(data-old-value);
    position: absolute;
    left: 0;
    top: 0;
    right: 0;
    opacity: 1;
    animation: numberFadeOut 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

@keyframes numberFadeIn {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

@keyframes numberFadeOut {
    from {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    to {
        opacity: 0;
        transform: translateY(-20px) scale(0.8);
    }
}

.rate-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.current-rate {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.btn-outline-purple {
    color: #a78bfa;
    border-color: #a78bfa;
}

.btn-outline-purple:hover {
    background-color: #a78bfa;
    color: #1f2937;
}

.btn-outline-purple.locked {
    background-color: #a78bfa;
    color: #1f2937;
}

/* Slider styles */
.slider-container {
    position: relative;
    width: 100%;
    padding: 10px 8px;
    margin: 0 -8px;
}

.custom-slider {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 100%;
    height: 4px;
    border-radius: 2px;
    background: rgba(167, 139, 250, 0.2);
    outline: none;
    transition: all 0.2s;
    margin: 0;
    padding: 0;
}

.custom-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #a78bfa;
    cursor: pointer;
    border: 2px solid #1f2937;
    box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.2);
    transition: all 0.2s;
}

.custom-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #a78bfa;
    cursor: pointer;
    border: 2px solid #1f2937;
    box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.2);
    transition: all 0.2s;
}

.custom-slider:hover::-webkit-slider-thumb {
    box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.3);
    transform: scale(1.1);
}

.custom-slider:hover::-moz-range-thumb {
    box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.3);
    transform: scale(1.1);
}

.custom-slider:active::-webkit-slider-thumb {
    transform: scale(1.2);
    background: #c4b5fd;
}

.custom-slider:active::-moz-range-thumb {
    transform: scale(1.2);
    background: #c4b5fd;
}

.recommended-rate.flash {
    animation: flashGreen 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes flashGreen {
    0% {
        color: #10B981;
        transform: scale(1.1);
    }
    100% {
        color: #9CA3AF;
        transform: scale(1);
    }
}

.save-button-container {
    padding: 0 1rem;
}

#save-parameters-btn {
    transition: all 0.2s;
}

#save-parameters-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(167, 139, 250, 0.2);
}

.overhead-expense td {
    color: #a78bfa;
    padding: 4px 8px;
}

.expense-subtotal td {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    padding: 8px;
    color: #a78bfa;
}

.truck-expense-header td {
    background: rgba(167, 139, 250, 0.1);
    padding: 8px;
    color: #a78bfa;
    font-weight: 500;
    border-top: 1px solid rgba(167, 139, 250, 0.2);
}

.truck-employee td {
    padding: 4px 16px;
    color: #e5e7eb;
    font-size: 0.9rem;
}

.truck-employee td:first-child {
    color: #9CA3AF;
    font-family: monospace;
}

.truck-subtotal td {
    padding: 4px 16px;
    color: #a78bfa;
    font-weight: 500;
    font-size: 0.9rem;
    border-bottom: 1px solid rgba(167, 139, 250, 0.1);
    margin-bottom: 8px;
}

.expenses-total {
    margin-top: 16px;
    border-top: 2px solid rgba(167, 139, 250, 0.3);
}

.expense-header td {
    background: rgba(167, 139, 250, 0.1);
    padding: 8px;
    color: #a78bfa;
    font-weight: 500;
    border-top: 1px solid rgba(167, 139, 250, 0.2);
}

.overhead-expense td {
    color: #e5e7eb;
    padding: 4px 8px;
}

.truck-expense-header td {
    background: rgba(167, 139, 250, 0.1);
    padding: 8px;
    color: #a78bfa;
    font-weight: 500;
    margin-top: 12px;
}

.truck-expense-item td {
    padding: 4px 16px;
    color: #e5e7eb;
}

.expense-subtotal td {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    padding: 8px;
    color: #a78bfa;
    font-weight: 500;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.rate-container.shake {
    animation: shake 0.5s ease-in-out;
}

.param-display-container {
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Add these new styles */
.card small.text-muted {
    color: #a78bfa !important;
    opacity: 0.8;
    transition: all 0.3s ease;
    display: inline-block;
    position: relative;
}

.card small.text-muted:after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 1px;
    background: #a78bfa;
    transition: width 0.3s ease;
}

.card:hover small.text-muted {
    opacity: 1;
    transform: translateY(-2px);
}

.card:hover small.text-muted:after {
    width: 100%;
}

@keyframes pulseText {
    0% { opacity: 0.8; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.02); }
    100% { opacity: 0.8; transform: scale(1); }
}

.text-animate {
    animation: pulseText 2s infinite ease-in-out;
}

.text-purple span {
    display: inline-block;
    transition: all 0.3s ease;
}

.text-purple span:hover {
    transform: translateY(-1px);
    text-shadow: 0 0 8px rgba(167, 139, 250, 0.5);
}

.employee-item {
    font-size: 0.85rem;
    color: #e2e8f0;
    padding: 0.25rem 0;
    border-bottom: 1px solid rgba(167, 139, 250, 0.1);
}

.employee-item:last-child {
    border-bottom: none;
}

.truck-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin: 1rem -0.5rem;
    padding: 0 0.5rem;
}

.metric-item {
    background: rgba(17, 24, 39, 0.5);
    padding: 0.75rem;
    border-radius: 6px;
    border: 1px solid rgba(167, 139, 250, 0.2);
    text-align: center;
    min-width: 0;
}

.metric-item .metric-label {
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.metric-item .metric-value {
    color: #e2e8f0;
    font-size: 0.9rem;
}

.truck-team {
    font-size: 0.9rem;
    color: #e2e8f0;
    margin-bottom: 1rem;
    line-height: 1.4;
}

.truck-card {
    background: rgba(17, 24, 39, 0.8);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
}

.truck-card:hover {
    background: rgba(17, 24, 39, 0.9);
    border-color: rgba(167, 139, 250, 0.3);
    transform: translateY(-1px);
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.truck-name {
    font-size: 1.1rem;
    font-weight: 500;
    color: #a78bfa;
    margin-bottom: 0.25rem;
}

.truck-details {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 0.5rem;
}

.truck-model {
    font-size: 0.85rem;
    color: #e2e8f0;
}

.truck-plate {
    font-size: 0.85rem;
    color: #9CA3AF;
    font-family: monospace;
    background: rgba(17, 24, 39, 0.5);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.truck-hours {
    font-size: 0.9rem;
    color: #a78bfa;
    font-weight: 500;
    background: rgba(167, 139, 250, 0.1);
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.truck-team {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(167, 139, 250, 0.1);
}

.team-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    font-size: 0.9rem;
}

.team-size {
    color: #a78bfa;
    font-weight: 500;
}

.service-area {
    color: #9CA3AF;
    font-size: 0.85rem;
}

.team-members {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.employee-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: rgba(17, 24, 39, 0.5);
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.1);
}

.employee-name {
    color: #e2e8f0;
    font-weight: 500;
    flex: 1;
}

.employee-position {
    color: #9CA3AF;
    font-size: 0.85rem;
    margin: 0 1rem;
}

.employee-wage {
    color: #a78bfa;
    font-family: monospace;
    font-size: 0.9rem;
    background: rgba(167, 139, 250, 0.1);
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.truck-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin: 1rem -0.5rem;
    padding: 0 0.5rem;
}

.metric-item {
    background: rgba(17, 24, 39, 0.5);
    padding: 0.75rem;
    border-radius: 6px;
    border: 1px solid rgba(167, 139, 250, 0.2);
    text-align: center;
    min-width: 0;
}

.metric-label {
    font-size: 0.75rem;
    color: #9CA3AF;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.metric-value {
    color: #e2e8f0;
    font-size: 1rem;
    font-weight: 500;
}
</style>

<script>
    let isUpdating = false;
    let isHourlyRateLocked = false;

    document.addEventListener('DOMContentLoaded', () => {
        console.log('Initializing dashboard...');
        
        // Set up the rate lock button
        const rateLockBtn = document.getElementById('rate-lock-btn');
        if (rateLockBtn) {
            rateLockBtn.addEventListener('click', () => {
                isHourlyRateLocked = !isHourlyRateLocked;
        updateLockButtonState();
            });
        }
        
        // Initial dashboard update
        updateDashboard(true);
        
        // Set up periodic updates
        setInterval(() => updateDashboard(), 30000);
    });

    function updateLockButtonState() {
        const lockButton = document.getElementById('rate-lock-btn');
        if (lockButton) {
            if (isHourlyRateLocked) {
                lockButton.innerHTML = '<i class="fas fa-lock"></i>';
                lockButton.classList.add('locked');
            } else {
                lockButton.innerHTML = '<i class="fas fa-lock-open"></i>';
                lockButton.classList.remove('locked');
            }
        }
    }

    function updateDashboard(forceUpdate = false) {
        if (!forceUpdate && isUpdating) return;
        
        console.log('Updating dashboard...');
        isUpdating = true;
        
        fetch('/get_dashboard_data')
            .then(response => response.json())
            .then(data => {
                console.log('Dashboard data:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load dashboard data');
                }
                
                // Update metrics
                const metrics = data.metrics;
                Object.entries(metrics).forEach(([key, value]) => {
                    const element = document.getElementById(key.replace(/_/g, '-'));
                    if (element) {
                        // Remove the dollar sign for margin values
                        if (key.includes('margin')) {
                            element.textContent = value;
                        } else {
                            element.textContent = value.replace(/^\$/, '');
                        }
                        element.style.color = ''; // Reset color
                        
                        // Add color coding for margins
                        if (key.includes('margin')) {
                            const marginValue = parseFloat(value);
                            if (marginValue < 0) {
                                element.style.color = '#ef4444'; // Red for negative
                            } else if (marginValue < 20) {
                                element.style.color = '#fbbf24'; // Yellow for low
                            } else {
                                element.style.color = '#10B981'; // Green for good
                            }
                        }
                    }
                });
                
                // Update efficiency rate display in billable hours card
            const billableHoursCard = document.querySelector('.card-body:has(#billable-hours)');
            if (billableHoursCard) {
                const smallText = billableHoursCard.querySelector('small.text-muted');
                if (smallText) {
                        const efficiencyRate = Math.round(data.business_parameters.efficiency_rate * 100);
                        smallText.innerHTML = `hours per month <span class="text-purple">(${efficiencyRate}% efficiency)</span>`;
                    }
                }

            // Update expenses list
            const expensesList = document.getElementById('expenses-list');
                if (expensesList) {
            expensesList.innerHTML = '';

                    // Group expenses by type
                    const overheadExpenses = data.expenses.filter(exp => exp.type === 'overhead');
                    const truckExpenses = data.expenses.filter(exp => ['truck_header', 'truck_employee', 'truck_subtotal'].includes(exp.type));

            // Add overhead expenses
                    if (overheadExpenses.length > 0) {
            expensesList.innerHTML += `
                <tr class="expense-header">
                                <td colspan="2">Overhead Expenses</td>
                </tr>
            `;
                        overheadExpenses.forEach(expense => {
                expensesList.innerHTML += `
                                <tr class="overhead-expense">
                                    <td>${expense.name}</td>
                                    <td class="text-end">${expense.amount}</td>
                    </tr>
                `;
            });
                    }
                    
                    // Add truck expenses with employee details
                    if (truckExpenses.length > 0) {
                expensesList.innerHTML += `
                    <tr class="expense-header">
                                <td colspan="2">Service Truck Expenses</td>
                    </tr>
                `;
                        truckExpenses.forEach(expense => {
                            let rowClass = '';
                            switch (expense.type) {
                                case 'truck_header':
                                    rowClass = 'truck-expense-header';
                                    break;
                                case 'truck_employee':
                                    rowClass = 'truck-employee';
                                    break;
                                case 'truck_subtotal':
                                    rowClass = 'truck-subtotal';
                                    break;
                            }
                        expensesList.innerHTML += `
                                <tr class="${rowClass}">
                                    <td>${expense.name}</td>
                                    <td class="text-end">${expense.amount}</td>
                            </tr>
                        `;
                    });
                    }
                }

            // Update trucks overview
            const trucksOverview = document.getElementById('trucks-overview');
                if (trucksOverview && data.trucks) {
            trucksOverview.innerHTML = '';
                    let totalEmployees = 0;
                    let totalHours = 0;
                    let totalTruckExpenses = 0;
                    
                    data.trucks.forEach(truck => {
                        const truckEmployees = truck.employees || [];
                        totalEmployees += truckEmployees.length;
                        totalHours += parseFloat(truck.effective_hours || 0);
                        
                        // Calculate total employee expenses for this truck
                        const employeeExpenses = truckEmployees.reduce((sum, emp) => {
                            const monthlyWage = parseFloat(emp.hourly_wage) * parseFloat(emp.hours_per_week) * 4;
                            return sum + monthlyWage;
                }, 0);

                        const totalTruckCost = parseFloat(truck.total_expenses) + employeeExpenses;
                        totalTruckExpenses += totalTruckCost;

                trucksOverview.innerHTML += `
                            <div class="truck-card">
                        <div class="truck-header">
                            <div class="truck-title">
                                        <div class="truck-name">${truck.name}</div>
                                <div class="truck-details">
                                            <span class="truck-model">${truck.year} ${truck.make} ${truck.model}</span>
                                    <span class="truck-plate">${truck.license_plate || 'No Plate'}</span>
                                </div>
                            </div>
                                    <div class="truck-hours">${truck.effective_hours} hrs/week</div>
                        </div>
                                
                        <div class="truck-metrics">
                            <div class="metric-item">
                                        <div class="metric-label">Vehicle Expenses</div>
                                        <div class="metric-value">$${truck.total_expenses.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div class="metric-item">
                                        <div class="metric-label">Employee Expenses</div>
                                        <div class="metric-value">$${employeeExpenses.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                            </div>
                            <div class="metric-item">
                                        <div class="metric-label">Total Monthly Cost</div>
                                        <div class="metric-value">$${totalTruckCost.toLocaleString('en-US', {minimumFractionDigits: 2})}</div>
                                    </div>
                                </div>
                                
                                <div class="truck-team">
                                    <div class="team-header">
                                        <span class="team-size">Team Size: ${truckEmployees.length} employees</span>
                                        ${truck.service_area ? `<span class="service-area">Service Area: ${truck.service_area}</span>` : ''}
                                    </div>
                                    <div class="team-members">
                                        ${truckEmployees.map(emp => `
                                            <div class="employee-item">
                                                <span class="employee-name">${emp.name}</span>
                                                <span class="employee-position">${emp.position}</span>
                                                <span class="employee-wage">$${(parseFloat(emp.hourly_wage) * parseFloat(emp.hours_per_week) * 4).toLocaleString('en-US', {minimumFractionDigits: 2})}/mo</span>
                                            </div>
                                        `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

                    // Update summary
                    document.getElementById('total-employees').textContent = `${totalEmployees} employees`;
            document.getElementById('total-hours').textContent = `${totalHours} hrs`;
                    document.getElementById('total-truck-expenses').textContent = 
                        `$${totalTruckExpenses.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                }

            // Update business parameters
                if (data.business_parameters) {
                    const params = data.business_parameters;
                    
                    // Update efficiency rate slider
                    const efficiencySlider = document.getElementById('efficiency-rate-input');
                    if (efficiencySlider) {
                        const value = Math.round(params.efficiency_rate * 100);
                        efficiencySlider.value = value;
                        const display = efficiencySlider.parentElement.parentElement.querySelector('.param-display');
                        if (display) {
                            display.textContent = value + '%';
                        }
                    }
                    
                    // Update profit margin slider
                    const profitMarginSlider = document.getElementById('profit-margin-input');
                    if (profitMarginSlider) {
                        const value = Math.round((1 - params.profit_margin_multiplier) * 100);
                        profitMarginSlider.value = value;
                        const display = profitMarginSlider.parentElement.parentElement.querySelector('.param-display');
                    if (display) {
                            display.textContent = value + '%';
                        }
                    }
                    
                    // Update hourly rate if not locked
                    if (!isHourlyRateLocked) {
                        const hourlyRateSlider = document.getElementById('hourlyRateSlider');
                        if (hourlyRateSlider) {
                            hourlyRateSlider.value = params.hourly_rate;
                            const display = hourlyRateSlider.parentElement.parentElement.querySelector('.param-display');
                    if (display) {
                                display.textContent = '$' + params.hourly_rate;
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error updating dashboard:', error);
                
                // Show error state in UI
                document.querySelectorAll('[id$="-hours"], [id$="-rate"], [id$="-expenses"], [id$="-revenue"], [id$="-profit"], [id$="-margin"]')
                    .forEach(element => {
                        element.textContent = '0.00';
                        element.style.color = '#ef4444';
                    });
                    
                // Clear expenses and trucks
                const expensesList = document.getElementById('expenses-list');
                if (expensesList) {
                    expensesList.innerHTML = '<tr><td colspan="2" class="text-center text-danger">Failed to load expenses</td></tr>';
                }
                
                const trucksOverview = document.getElementById('trucks-overview');
                if (trucksOverview) {
                    trucksOverview.innerHTML = '<div class="text-center text-danger">Failed to load trucks</div>';
                }
            })
            .finally(() => {
                isUpdating = false;
            });
    }

    // Add debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Debounced update function
    const debouncedUpdateParameters = debounce((updates) => {
        fetch('/save_business_parameters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ...updates,
                preserve_lock_state: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Parameters updated successfully');
                updateDashboard(true); // Force immediate update
            }
        })
        .catch(error => {
            console.error('Error updating parameters:', error);
        });
    }, 300); // 300ms debounce

    function handleSliderInput(input, parameter, valueTransform) {
        const value = valueTransform(parseFloat(input.value));
        const display = input.parentElement.parentElement.querySelector('.param-display');
        if (display) {
            display.textContent = input.value + '%';
        }
        
        // Update pending changes
        const updates = {
            [parameter]: value
        };
        
        // Trigger debounced update
        debouncedUpdateParameters(updates);
    }

    function handleSliderRelease(input, parameter, valueTransform) {
        const value = valueTransform(parseFloat(input.value));
        
        // Immediate update on release
        fetch('/save_business_parameters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                [parameter]: value,
                preserve_lock_state: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Parameters updated successfully');
                updateDashboard(true); // Force immediate update
            }
        })
        .catch(error => {
            console.error('Error updating parameters:', error);
        });
    }

    function handleHourlyRateSlider(input) {
        if (isUpdating) return;
        
        const value = parseFloat(input.value);
        const display = input.parentElement.parentElement.querySelector('.param-display');
        if (display) {
            display.textContent = '$' + value;
        }
        
        // Update the hourly rate display
        const hourlyRateDisplay = document.getElementById('hourly-rate');
        if (hourlyRateDisplay) {
            hourlyRateDisplay.textContent = value.toFixed(2);
        }
        
        // If it's not already locked, lock it
        if (!isHourlyRateLocked) {
            isHourlyRateLocked = true;
            updateLockButtonState();
        }
        
        // Debounce the update
        debouncedUpdateParameters({
            hourly_rate: value
        });
    }

    function handleHourlyRateRelease(input) {
        if (isUpdating) return;
        
        const value = parseFloat(input.value);
        
        // Immediate update on release
        fetch('/save_business_parameters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                hourly_rate: value,
                preserve_lock_state: true
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDashboard(true); // Force immediate update
            }
        })
        .catch(error => {
            console.error('Error updating hourly rate:', error);
        });
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize sliders with values from business_parameters.json
        fetch('/get_settings')
            .then(response => response.json())
            .then(data => {
                const params = data.business_parameters;
                
                // Set efficiency rate (convert from decimal to percentage)
                const efficiencyInput = document.getElementById('efficiency-rate-input');
                if (efficiencyInput) {
                    const efficiencyPercent = Math.round(params.efficiency_rate * 100);
                    efficiencyInput.value = efficiencyPercent;
                    const display = efficiencyInput.parentElement.parentElement.querySelector('.param-display');
                    if (display) {
                        display.textContent = efficiencyPercent + '%';
                    }
                }
                
                // Set profit margin (convert from decimal to percentage)
                const profitMarginInput = document.getElementById('profit-margin-input');
                if (profitMarginInput) {
                    const profitPercent = Math.round((1 - params.profit_margin_multiplier) * 100);
                    profitMarginInput.value = profitPercent;
                    const display = profitMarginInput.parentElement.parentElement.querySelector('.param-display');
                    if (display) {
                        display.textContent = profitPercent + '%';
                    }
                }
                
                // Set hourly rate
                const hourlyRateSlider = document.getElementById('hourlyRateSlider');
                if (hourlyRateSlider) {
                    hourlyRateSlider.value = params.hourly_rate;
                    const display = hourlyRateSlider.parentElement.parentElement.querySelector('.param-display');
                    if (display) {
                        display.textContent = '$' + params.hourly_rate;
                    }
                }
                
                updateDashboard();
            });
    });

    // Update dashboard every 30 seconds
    setInterval(updateDashboard, 30000);

    function sortExpenses(by) {
        const expensesList = document.getElementById('expenses-list');
        const rows = Array.from(expensesList.children);
        
        rows.sort((a, b) => {
            if (by === 'name') {
                const nameA = a.cells[0].textContent.toLowerCase();
                const nameB = b.cells[0].textContent.toLowerCase();
                return nameA.localeCompare(nameB);
            } else if (by === 'amount') {
                const amountA = parseFloat(a.cells[1].textContent.replace(/[^0-9.-]+/g, ''));
                const amountB = parseFloat(b.cells[1].textContent.replace(/[^0-9.-]+/g, ''));
                return amountB - amountA;
            }
        });
        
        expensesList.innerHTML = '';
        rows.forEach(row => expensesList.appendChild(row));
    }

    // Add this new function for synchronization
    function syncEfficiencyRate() {
        const efficiencyInput = document.getElementById('efficiency-rate-input');
        const efficiencyRate = Math.round(dashData.business_parameters.efficiency_rate * 100);
        
        // Update slider value
        if (efficiencyInput) {
            efficiencyInput.value = efficiencyRate;
            const display = efficiencyInput.parentElement.parentElement.querySelector('.param-display');
            if (display) {
                display.textContent = efficiencyRate + '%';
            }
        }

        // Update dashboard display
        const billableHoursCard = document.querySelector('.card-body:has(#billable-hours)');
        if (billableHoursCard) {
            const smallText = billableHoursCard.querySelector('small.text-muted');
            if (smallText) {
                smallText.innerHTML = `hours per month <span class="text-purple">(${efficiencyRate}% efficiency)</span>`;
            }
        }
    }

    // Add event listener for efficiency rate changes
    document.addEventListener('DOMContentLoaded', () => {
        const efficiencyInput = document.getElementById('efficiency-rate-input');
        if (efficiencyInput) {
            efficiencyInput.addEventListener('input', () => {
                const billableHoursCard = document.querySelector('.card-body:has(#billable-hours)');
                if (billableHoursCard) {
                    const smallText = billableHoursCard.querySelector('small.text-muted');
                    if (smallText) {
                        smallText.innerHTML = `hours per month <span class="text-purple">(${efficiencyInput.value}% efficiency)</span>`;
                    }
                }
            });
        }
    });
</script>
{% endblock %} 