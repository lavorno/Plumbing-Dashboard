{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card bg-dark text-white">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="sort-controls">
                    <span class="text-purple me-2">Sort by:</span>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('name')">
                            <i class="fas fa-sort-alpha-down"></i> Name
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('revenue')">
                            <i class="fas fa-sort-numeric-down"></i> Revenue
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('profit')">
                            <i class="fas fa-sort-numeric-down"></i> Profit
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('expenses')">
                            <i class="fas fa-sort-numeric-down"></i> Expenses
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('team')">
                            <i class="fas fa-sort-numeric-down"></i> Team Size
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="showAddTruckModal()">
                    <i class="fas fa-plus"></i> Add New Truck
                </button>
            </div>

            <div id="truckTableBody">
                <!-- Trucks will be added here dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Truck Modal -->
<div class="modal fade" id="truckModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title text-purple">Add New Truck</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="truckForm">
                <div class="modal-body">
                    <div id="truckFormAlerts"></div>
                    <input type="hidden" name="truck_id" id="truckId">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-purple mb-3">Truck Information</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Truck Name/Number</label>
                                <input type="text" class="form-control" name="name" id="truckName" required 
                                       placeholder="e.g., Truck #1">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Make</label>
                                <input type="text" class="form-control" name="make" id="truckMake" required 
                                       placeholder="e.g., Ford">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" name="model" id="truckModel" required 
                                       placeholder="e.g., Transit">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Year</label>
                                <input type="number" class="form-control" name="year" id="truckYear" required 
                                       min="1900" max="2100" placeholder="e.g., 2023">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">License Plate</label>
                                <input type="text" class="form-control" name="license_plate" id="truckLicense" required 
                                       placeholder="License plate number">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-purple mb-3">Monthly Expenses</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Loan/Lease Payment</label>
                                <input type="number" class="form-control" name="loan_payment" id="truckLoanPayment" 
                                       min="0" step="0.01" placeholder="Monthly payment">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Insurance</label>
                                <input type="number" class="form-control" name="insurance" id="truckInsurance" 
                                       min="0" step="0.01" placeholder="Monthly insurance">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Fuel Budget</label>
                                <input type="number" class="form-control" name="fuel_budget" id="truckFuelBudget" 
                                       min="0" step="0.01" placeholder="Monthly fuel estimate">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Maintenance Budget</label>
                                <input type="number" class="form-control" name="maintenance_budget" id="truckMaintenanceBudget" 
                                       min="0" step="0.01" placeholder="Monthly maintenance estimate">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Other Expenses</label>
                                <input type="number" class="form-control" name="other_expenses" id="truckOtherExpenses" 
                                       min="0" step="0.01" placeholder="Other monthly expenses">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-purple mb-3">Team & Hours</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Assigned Employees</label>
                                <select class="form-control" name="employee_ids" id="truckEmployees" multiple>
                                    <!-- Employees will be populated here -->
                                </select>
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Effective Weekly Hours</label>
                                <input type="number" class="form-control" name="effective_hours" id="truckEffectiveHours" 
                                       min="0" max="168" step="0.5" placeholder="Override total team hours if needed">
                                <small class="text-muted">Leave blank to use sum of employee hours</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-purple mb-3">Additional Information</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Service Area</label>
                                <input type="text" class="form-control" name="service_area" id="truckServiceArea" 
                                       placeholder="Primary service area">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" id="truckNotes" rows="3" 
                                          placeholder="Additional notes about the truck"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Truck</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.expense-group {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 12px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.expense-group:hover {
    border-color: rgba(167, 139, 250, 0.5);
}

.table td {
    vertical-align: middle;
}

.truck-info {
    font-size: 0.9rem;
}

.truck-info .label {
    color: #a78bfa;
    font-weight: 500;
}

.truck-expenses {
    font-size: 0.9rem;
}

.truck-expenses .expense-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.truck-expenses .expense-total {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    margin-top: 4px;
    padding-top: 4px;
    font-weight: 500;
}

.employee-tag {
    display: inline-block;
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 4px;
    padding: 2px 8px;
    margin: 2px;
    font-size: 0.9rem;
}

.revenue-box {
    text-align: right;
}

.revenue-box .amount {
    font-size: 1.1rem;
    font-weight: 500;
    color: #10b981;
}

.revenue-box .label {
    font-size: 0.8rem;
    color: #a78bfa;
}

.team-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.employee-tag {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 4px;
    padding: 0.5rem;
}

.wage-info {
    font-size: 0.8rem;
    color: #a78bfa;
    margin-top: 0.25rem;
}

.hours-info {
    font-size: 0.9rem;
}

.expenses-info {
    font-size: 0.9rem;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.25rem;
}

.expense-total {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
}

.revenue-info {
    text-align: right;
}

.revenue-box, .profit-box {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 4px;
    padding: 0.5rem;
}

.metric-label {
    font-size: 0.8rem;
    color: #9CA3AF;
    margin-bottom: 0.25rem;
}

.amount {
    font-size: 1.1rem;
    font-weight: 500;
}

.rate-info, .margin-info {
    font-size: 0.8rem;
    color: #a78bfa;
    margin-top: 0.25rem;
}

.text-success {
    color: #10B981 !important;
}

.text-danger {
    color: #EF4444 !important;
}

.expense-subtotal {
    border-top: 1px solid rgba(167, 139, 250, 0.1);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    color: #a78bfa;
}

.expense-total {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
}

.expenses-info {
    font-size: 0.9rem;
    background: rgba(17, 24, 39, 0.3);
    border-radius: 6px;
    padding: 0.75rem;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.expense-item:hover {
    background: rgba(167, 139, 250, 0.05);
    border-radius: 4px;
}

.truck-profile {
    background: rgba(17, 24, 39, 0.3);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.truck-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.truck-title h4 {
    color: #a78bfa;
    margin: 0;
}

.truck-subtitle {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
}

.model-badge, .plate-badge, .area-badge {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.plate-badge {
    font-family: monospace;
}

.truck-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.content-section {
    background: rgba(17, 24, 39, 0.2);
    border-radius: 8px;
    padding: 1.25rem;
}

.section-title {
    color: #a78bfa;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.team-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.employee-card {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 6px;
    padding: 1rem;
}

.employee-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.employee-position {
    color: #9CA3AF;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
}

.employee-stats {
    display: grid;
    gap: 0.5rem;
}

.stat {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
}

.stat-label {
    color: #9CA3AF;
}

.metrics-grid {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    gap: 1rem;
}

.metric-card {
    background: rgba(17, 24, 39, 0.2);
    border-radius: 6px;
    padding: 1rem;
}

.metric-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
}

.metric-label {
    color: #9CA3AF;
    font-size: 0.9rem;
}

.metric-value {
    font-weight: 500;
}

.expense-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.expense-totals {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(167, 139, 250, 0.2);
}

.metric-value.revenue {
    color: #10B981;
}

.metric-value.profit {
    color: #10B981;
}

.metric-value.loss {
    color: #EF4444;
}

.subtotal {
    color: #a78bfa;
    font-size: 0.9rem;
}

.total {
    font-size: 1.1rem;
    font-weight: 600;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-buttons .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table > :not(caption) > * > * {
    padding: 0;
}

.sort-controls {
    display: flex;
    align-items: center;
}

.sort-controls .btn-group {
    margin-left: 0.5rem;
}

.sort-controls .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
}

.sort-controls .btn i {
    font-size: 0.8rem;
}

.sort-controls .btn.active {
    background: rgba(167, 139, 250, 0.2);
    border-color: rgba(167, 139, 250, 0.5);
}

.truck-card {
    background: rgba(17, 24, 39, 0.3);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
}

.truck-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.truck-title {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.truck-name {
    font-size: 1.1rem;
    font-weight: 500;
    color: #a78bfa;
}

.truck-details {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.truck-model {
    font-size: 0.8rem;
    color: #e2e8f0;
}

.truck-plate {
    font-size: 0.8rem;
    color: #9CA3AF;
    font-family: monospace;
    background: rgba(17, 24, 39, 0.5);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.truck-team {
    font-size: 0.9rem;
    color: #e2e8f0;
    margin-bottom: 1.5rem;
}

.truck-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.metric-item {
    background: rgba(17, 24, 39, 0.5);
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.metric-item.revenue {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.metric-item.profit {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.25);
}

.metric-item.loss {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.metric-label {
    font-size: 0.8rem;
    color: #9CA3AF;
    margin-bottom: 0.5rem;
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 500;
}

.metric-item.revenue .metric-value,
.metric-item.profit .metric-value {
    color: #10B981;
}

.metric-item.loss .metric-value {
    color: #EF4444;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-buttons .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sort-controls {
    display: flex;
    align-items: center;
}

.sort-controls .btn-group {
    margin-left: 0.5rem;
}

.sort-controls .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
}

.sort-controls .btn i {
    font-size: 0.8rem;
}

.sort-controls .btn.active {
    background: rgba(167, 139, 250, 0.2);
    border-color: rgba(167, 139, 250, 0.5);
}
</style>

{% block scripts %}
<script>
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

function formatNumber(num) {
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

let currentTrucks = [];

function sortTrucks(by) {
    currentTrucks.sort((a, b) => {
        switch(by) {
            case 'name':
                return a.name.localeCompare(b.name);
            
            case 'revenue': {
                const revenueA = calculateRevenue(a);
                const revenueB = calculateRevenue(b);
                return revenueB - revenueA;
            }
            
            case 'profit': {
                const profitA = calculateProfit(a);
                const profitB = calculateProfit(b);
                return profitB - profitA;
            }
            
            case 'expenses': {
                const expensesA = calculateTotalExpenses(a);
                const expensesB = calculateTotalExpenses(b);
                return expensesB - expensesA;
            }
            
            case 'team':
                return b.employees.length - a.employees.length;
            
            default:
                return 0;
        }
    });
    
    renderTrucks();
}

function calculateRevenue(truck) {
    const weeklyHours = truck.effective_hours || truck.employees.reduce((sum, emp) => sum + parseFloat(emp.hours_per_week), 0);
    const monthlyBillableHours = weeklyHours * 4 * window.efficiencyRate;
    return monthlyBillableHours * window.hourlyRate;
}

function calculateTotalExpenses(truck) {
    const crewWages = truck.employees.reduce((sum, emp) => {
        return sum + (parseFloat(emp.hourly_wage) * parseFloat(emp.hours_per_week) * 4);
    }, 0);
    
    const truckExpenses = calculateTotalTruckExpenses(truck);
    return crewWages + truckExpenses;
}

function calculateProfit(truck) {
    const revenue = calculateRevenue(truck);
    const expenses = calculateTotalExpenses(truck);
    return revenue - expenses;
}

function loadTrucks() {
    Promise.all([
        fetch('/get_trucks').then(response => response.json()),
        fetch('/get_employees').then(response => response.json()),
        fetch('/get_dashboard_data').then(response => response.json())
    ]).then(([truckData, employeeData, dashData]) => {
        currentTrucks = truckData.trucks;
        window.efficiencyRate = dashData.business_parameters.efficiency_rate;
        window.hourlyRate = parseFloat(dashData.metrics.hourly_rate);
        window.profitMargin = 1 - dashData.business_parameters.profit_margin_multiplier;
        
        // Merge employee data into trucks
        currentTrucks = currentTrucks.map(truck => {
            truck.employees = truck.employee_ids.map(id => 
                employeeData.employees.find(emp => emp.employee_id === id)
            ).filter(emp => emp); // Filter out any undefined employees
            return truck;
        });

        renderTrucks(window.efficiencyRate, window.hourlyRate);

        // Update employee select options
        const employeeSelect = document.getElementById('truckEmployees');
        employeeSelect.innerHTML = employeeData.employees.map(emp => 
            `<option value="${emp.employee_id}">${emp.name} - ${emp.position}</option>`
        ).join('');
    });
}

function renderTrucks(efficiencyRate, hourlyRate) {
    const tableBody = document.getElementById('truckTableBody');
    tableBody.innerHTML = '';
    
    currentTrucks.forEach(truck => {
        // Calculate financial metrics
        const weeklyHours = truck.effective_hours || truck.employees.reduce((sum, emp) => 
            sum + (parseFloat(emp.hours_per_week) || 0), 0);
        const monthlyHours = weeklyHours * 4;
        
        // Calculate crew wages (monthly)
        const crewWages = truck.employees.reduce((sum, emp) => 
            sum + ((parseFloat(emp.hourly_wage) || 0) * (parseFloat(emp.hours_per_week) || 0) * 4), 0);

        // Calculate truck expenses
        const truckExpenses = calculateTotalTruckExpenses(truck);
        const totalMonthlyExpenses = truckExpenses + crewWages;

        // Calculate revenue and profit
        const monthlyBillableHours = weeklyHours * 4 * efficiencyRate;
        const revenue = monthlyBillableHours * hourlyRate;
        const profit = revenue - totalMonthlyExpenses;
        const profitMargin = revenue > 0 ? (profit / revenue) * 100 : 0;

        const truckElement = document.createElement('div');
        truckElement.className = 'truck-profile mb-4';
        truckElement.innerHTML = `
            <div class="truck-header">
                <div class="truck-title">
                    <h4 class="mb-2">${truck.name}</h4>
                    <div class="truck-subtitle">
                        <span class="model-badge">${truck.make || ''} ${truck.model || ''} ${truck.year || ''}</span>
                        <span class="plate-badge">${truck.license_plate || ''}</span>
                        <span class="area-badge">${truck.service_area || 'Not specified'}</span>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-outline-primary" onclick="editTruck('${truck.truck_id}')">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTruck('${truck.truck_id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>

            <div class="truck-content">
                <div class="content-section team-section">
                    <h6 class="section-title">Team Members</h6>
                    <div class="team-grid">
                        ${truck.employees.map(emp => `
                            <div class="employee-card">
                                <div class="employee-name">${emp.name}</div>
                                <div class="employee-position">${emp.position}</div>
                                <div class="employee-stats">
                                    <div class="stat">
                                        <span class="stat-label">Rate:</span>
                                        <span class="stat-value">${formatCurrency(emp.hourly_wage)}/hr</span>
                                    </div>
                                    <div class="stat">
                                        <span class="stat-label">Hours:</span>
                                        <span class="stat-value">${emp.hours_per_week} hrs/week</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="content-section metrics-section">
                    <div class="metrics-grid">
                        <div class="metric-card hours-card">
                            <h6 class="section-title">Hours</h6>
                            <div class="metric-content">
                                <div class="metric-row">
                                    <span class="metric-label">Weekly Hours:</span>
                                    <span class="metric-value">${weeklyHours} hrs</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Monthly Billable:</span>
                                    <span class="metric-value">${monthlyBillableHours.toFixed(1)} hrs</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Efficiency Rate:</span>
                                    <span class="metric-value">${(efficiencyRate * 100).toFixed(0)}%</span>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card expenses-card">
                            <h6 class="section-title">Monthly Expenses</h6>
                            <div class="metric-content">
                                <div class="expense-grid">
                                    <div class="expense-column">
                                        <div class="metric-row">
                                            <span class="metric-label">Crew Wages:</span>
                                            <span class="metric-value">${formatCurrency(crewWages)}</span>
                                        </div>
                                        ${truck.loan_payment > 0 ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Loan/Lease:</span>
                                                <span class="metric-value">${formatCurrency(truck.loan_payment)}</span>
                                            </div>
                                        ` : ''}
                                        ${truck.insurance > 0 ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Insurance:</span>
                                                <span class="metric-value">${formatCurrency(truck.insurance)}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div class="expense-column">
                                        ${truck.fuel_budget > 0 ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Fuel:</span>
                                                <span class="metric-value">${formatCurrency(truck.fuel_budget)}</span>
                                            </div>
                                        ` : ''}
                                        ${truck.maintenance_budget > 0 ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Maintenance:</span>
                                                <span class="metric-value">${formatCurrency(truck.maintenance_budget)}</span>
                                            </div>
                                        ` : ''}
                                        ${truck.other_expenses > 0 ? `
                                            <div class="metric-row">
                                                <span class="metric-label">Other:</span>
                                                <span class="metric-value">${formatCurrency(truck.other_expenses)}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="expense-totals">
                                    <div class="metric-row subtotal">
                                        <span class="metric-label">Vehicle Total:</span>
                                        <span class="metric-value">${formatCurrency(truckExpenses)}</span>
                                    </div>
                                    <div class="metric-row total">
                                        <span class="metric-label">Total Monthly:</span>
                                        <span class="metric-value">${formatCurrency(totalMonthlyExpenses)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="metric-card revenue-card">
                            <h6 class="section-title">Financial Metrics</h6>
                            <div class="metric-content">
                                <div class="revenue-section">
                                    <div class="metric-row">
                                        <span class="metric-label">Hourly Rate:</span>
                                        <span class="metric-value">${formatCurrency(hourlyRate)}/hr</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Monthly Revenue:</span>
                                        <span class="metric-value revenue">${formatCurrency(revenue)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Monthly Profit:</span>
                                        <span class="metric-value ${profit >= 0 ? 'profit' : 'loss'}">${formatCurrency(profit)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Profit Margin:</span>
                                        <span class="metric-value ${profit >= 0 ? 'profit' : 'loss'}">${profitMargin.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        tableBody.appendChild(truckElement);
    });
}

function calculateTotalTruckExpenses(truck) {
    return (parseFloat(truck.loan_payment) || 0) +
           (parseFloat(truck.insurance) || 0) +
           (parseFloat(truck.fuel_budget) || 0) +
           (parseFloat(truck.maintenance_budget) || 0) +
           (parseFloat(truck.other_expenses) || 0);
}

function showAddTruckModal() {
    const modal = document.getElementById('truckModal');
    const form = document.getElementById('truckForm');
    form.reset();
    document.getElementById('truckId').value = '';
    modal.querySelector('.modal-title').textContent = 'Add New Truck';
    new bootstrap.Modal(modal).show();
}

function editTruck(truckId) {
    fetch(`/get_truck/${truckId}`)
        .then(response => response.json())
        .then(truck => {
            const modal = document.getElementById('truckModal');
            modal.querySelector('.modal-title').textContent = 'Edit Truck';
            
            document.getElementById('truckId').value = truck.truck_id;
            document.getElementById('truckName').value = truck.name;
            document.getElementById('truckMake').value = truck.make || '';
            document.getElementById('truckModel').value = truck.model || '';
            document.getElementById('truckYear').value = truck.year || '';
            document.getElementById('truckLicense').value = truck.license_plate || '';
            document.getElementById('truckLoanPayment').value = truck.loan_payment || '';
            document.getElementById('truckInsurance').value = truck.insurance || '';
            document.getElementById('truckFuelBudget').value = truck.fuel_budget || '';
            document.getElementById('truckMaintenanceBudget').value = truck.maintenance_budget || '';
            document.getElementById('truckOtherExpenses').value = truck.other_expenses || '';
            document.getElementById('truckEffectiveHours').value = truck.effective_hours || '';
            document.getElementById('truckServiceArea').value = truck.service_area || '';
            document.getElementById('truckNotes').value = truck.notes || '';
            
            // Set selected employees
            const employeeSelect = document.getElementById('truckEmployees');
            if (employeeSelect) {
                Array.from(employeeSelect.options).forEach(option => {
                    option.selected = truck.employee_ids.includes(option.value);
                });
            }
            
            new bootstrap.Modal(modal).show();
        });
}

function deleteTruck(truckId) {
    if (confirm('Are you sure you want to delete this truck? This will affect your business calculations.')) {
        fetch(`/delete_truck/${truckId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTrucks();
                showNotification('Truck deleted');
            } else {
                showNotification('Failed to delete truck', 'error');
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadTrucks();
    
    document.getElementById('truckForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const employeeSelect = document.getElementById('truckEmployees');
        const selectedEmployees = Array.from(employeeSelect.selectedOptions).map(option => option.value);
        
        const data = {
            truck_id: formData.get('truck_id'),
            name: formData.get('name'),
            make: formData.get('make'),
            model: formData.get('model'),
            year: formData.get('year'),
            license_plate: formData.get('license_plate'),
            loan_payment: formData.get('loan_payment') ? parseFloat(formData.get('loan_payment')) : 0,
            insurance: formData.get('insurance') ? parseFloat(formData.get('insurance')) : 0,
            fuel_budget: formData.get('fuel_budget') ? parseFloat(formData.get('fuel_budget')) : 0,
            maintenance_budget: formData.get('maintenance_budget') ? parseFloat(formData.get('maintenance_budget')) : 0,
            other_expenses: formData.get('other_expenses') ? parseFloat(formData.get('other_expenses')) : 0,
            employee_ids: selectedEmployees,
            effective_hours: formData.get('effective_hours') && formData.get('effective_hours').trim() !== '' ? 
                           parseFloat(formData.get('effective_hours')) : null,
            service_area: formData.get('service_area'),
            notes: formData.get('notes')
        };
        
        const isEdit = data.truck_id;
        fetch(isEdit ? `/update_truck/${data.truck_id}` : '/add_truck', {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('truckModal')).hide();
                loadTrucks();
                showNotification(`Truck ${isEdit ? 'updated' : 'added'}`);
            } else {
                showNotification(data.error || 'Failed to save truck', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to save truck: ' + error.message, 'error');
        });
    });
});
</script>
{% endblock %}
{% endblock %} 