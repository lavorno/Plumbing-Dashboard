{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="card bg-dark text-white">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="sort-controls">
                    <span class="text-purple me-2">Sort by:</span>
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('name')">
                            <i class="fas fa-sort-alpha-down"></i> Name
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('revenue')">
                            <i class="fas fa-sort-numeric-down"></i> Revenue
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('profit')">
                            <i class="fas fa-sort-numeric-down"></i> Profit
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('expenses')">
                            <i class="fas fa-sort-numeric-down"></i> Expenses
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="sortTrucks('team')">
                            <i class="fas fa-sort-numeric-down"></i> Team Size
                        </button>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="showAddTruckModal()">
                    <i class="fas fa-plus"></i> Add New Truck
                </button>
            </div>

            <div id="truckContainer">
                <!-- Trucks will be added here dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Truck Modal -->
<div class="modal fade" id="truckModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-0">
                <h5 class="modal-title text-purple">Add New Truck</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="truckForm">
                <div class="modal-body">
                    <div id="truckFormAlerts"></div>
                    <input type="hidden" name="truck_id" id="truckId">
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6 class="text-purple mb-3">Truck Information</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Truck Name/Number</label>
                                <input type="text" class="form-control" name="name" id="truckName" required 
                                       placeholder="e.g., Truck #1">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Make</label>
                                <input type="text" class="form-control" name="make" id="truckMake" required 
                                       placeholder="e.g., Ford">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" name="model" id="truckModel" required 
                                       placeholder="e.g., Transit">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Year</label>
                                <input type="number" class="form-control" name="year" id="truckYear" required 
                                       min="1900" max="2100" placeholder="e.g., 2023">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">License Plate</label>
                                <input type="text" class="form-control" name="license_plate" id="truckLicense" required 
                                       placeholder="License plate number">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-purple mb-3">Monthly Expenses</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Loan/Lease Payment</label>
                                <input type="number" class="form-control" name="loan_payment" id="truckLoanPayment" 
                                       min="0" step="0.01" placeholder="Monthly payment">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Insurance</label>
                                <input type="number" class="form-control" name="insurance" id="truckInsurance" 
                                       min="0" step="0.01" placeholder="Monthly insurance">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Fuel Budget</label>
                                <input type="number" class="form-control" name="fuel_budget" id="truckFuelBudget" 
                                       min="0" step="0.01" placeholder="Monthly fuel estimate">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Maintenance Budget</label>
                                <input type="number" class="form-control" name="maintenance_budget" id="truckMaintenanceBudget" 
                                       min="0" step="0.01" placeholder="Monthly maintenance estimate">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Other Expenses</label>
                                <input type="number" class="form-control" name="other_expenses" id="truckOtherExpenses" 
                                       min="0" step="0.01" placeholder="Other monthly expenses">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-purple mb-3">Team & Hours</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Assigned Employees</label>
                                <select class="form-control" name="employee_ids" id="truckEmployees" multiple>
                                    <!-- Employees will be populated here -->
                                </select>
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Effective Weekly Hours</label>
                                <input type="number" class="form-control" name="effective_hours" id="truckEffectiveHours" 
                                       min="0" max="168" step="0.5" placeholder="Override total team hours if needed">
                                <small class="text-muted">Leave blank to use sum of employee hours</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <h6 class="text-purple mb-3">Additional Information</h6>
                            <div class="expense-group mb-2">
                                <label class="form-label">Service Area</label>
                                <input type="text" class="form-control" name="service_area" id="truckServiceArea" 
                                       placeholder="Primary service area">
                            </div>
                            <div class="expense-group mb-2">
                                <label class="form-label">Notes</label>
                                <textarea class="form-control" name="notes" id="truckNotes" rows="3" 
                                          placeholder="Additional notes about the truck"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Truck</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.expense-group {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 12px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.expense-group:hover {
    border-color: rgba(167, 139, 250, 0.5);
}

.table td {
    vertical-align: middle;
}

.truck-info {
    font-size: 0.9rem;
}

.truck-info .label {
    color: #a78bfa;
    font-weight: 500;
}

.truck-expenses {
    font-size: 0.9rem;
}

.truck-expenses .expense-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
}

.truck-expenses .expense-total {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    margin-top: 4px;
    padding-top: 4px;
    font-weight: 500;
}

.employee-tag {
    display: inline-block;
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 4px;
    padding: 2px 8px;
    margin: 2px;
    font-size: 0.9rem;
}

.revenue-box {
    text-align: right;
}

.revenue-box .amount {
    font-size: 1.1rem;
    font-weight: 500;
    color: #10b981;
}

.revenue-box .label {
    font-size: 0.8rem;
    color: #a78bfa;
}

.team-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.employee-tag {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 4px;
    padding: 0.5rem;
}

.wage-info {
    font-size: 0.8rem;
    color: #a78bfa;
    margin-top: 0.25rem;
}

.hours-info {
    font-size: 0.9rem;
}

.expenses-info {
    font-size: 0.9rem;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.25rem;
}

.expense-total {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
}

.revenue-info {
    text-align: right;
}

.revenue-box, .profit-box {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 4px;
    padding: 0.5rem;
}

.metric-label {
    font-size: 0.8rem;
    color: #9CA3AF;
    margin-bottom: 0.25rem;
}

.amount {
    font-size: 1.1rem;
    font-weight: 500;
}

.rate-info, .margin-info {
    font-size: 0.8rem;
    color: #a78bfa;
    margin-top: 0.25rem;
}

.text-success {
    color: #10B981 !important;
}

.text-danger {
    color: #EF4444 !important;
}

.expense-subtotal {
    border-top: 1px solid rgba(167, 139, 250, 0.1);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
    color: #a78bfa;
}

.expense-total {
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    font-weight: 500;
    display: flex;
    justify-content: space-between;
}

.expenses-info {
    font-size: 0.9rem;
    background: rgba(17, 24, 39, 0.3);
    border-radius: 6px;
    padding: 0.75rem;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
}

.expense-item:hover {
    background: rgba(167, 139, 250, 0.05);
    border-radius: 4px;
}

.truck-profile {
    background: rgba(17, 24, 39, 0.3);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.truck-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
}

.truck-title h4 {
    color: #a78bfa;
    margin: 0;
}

.truck-subtitle {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
}

.model-badge, .plate-badge, .area-badge {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.9rem;
}

.plate-badge {
    font-family: monospace;
}

.truck-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.content-section {
    background: rgba(17, 24, 39, 0.2);
    border-radius: 8px;
    padding: 1.25rem;
}

.section-title {
    color: #a78bfa;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.team-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.employee-card {
    background: rgba(167, 139, 250, 0.1);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 6px;
    padding: 1rem;
}

.employee-name {
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.employee-position {
    color: #9CA3AF;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
}

.employee-stats {
    display: grid;
    gap: 0.5rem;
}

.stat {
    display: flex;
    justify-content: space-between;
    font-size: 0.9rem;
}

.stat-label {
    color: #9CA3AF;
}

.metrics-grid {
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    gap: 1rem;
}

.metric-card {
    background: rgba(17, 24, 39, 0.2);
    border-radius: 6px;
    padding: 1rem;
}

.metric-content {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.metric-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
}

.metric-label {
    color: #9CA3AF;
    font-size: 0.9rem;
}

.metric-value {
    font-weight: 500;
}

.expense-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.expense-totals {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(167, 139, 250, 0.2);
}

.metric-value.revenue {
    color: #10B981;
}

.metric-value.profit {
    color: #10B981;
}

.metric-value.loss {
    color: #EF4444;
}

.subtotal {
    color: #a78bfa;
    font-size: 0.9rem;
}

.total {
    font-size: 1.1rem;
    font-weight: 600;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-buttons .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table > :not(caption) > * > * {
    padding: 0;
}

.sort-controls {
    display: flex;
    align-items: center;
}

.sort-controls .btn-group {
    margin-left: 0.5rem;
}

.sort-controls .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
}

.sort-controls .btn i {
    font-size: 0.8rem;
}

.sort-controls .btn.active {
    background: rgba(167, 139, 250, 0.2);
    border-color: rgba(167, 139, 250, 0.5);
}

.truck-card {
    background: rgba(17, 24, 39, 0.3);
    border: 1px solid rgba(167, 139, 250, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
}

.truck-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.truck-title {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.truck-name {
    font-size: 1.1rem;
    font-weight: 500;
    color: #a78bfa;
}

.truck-details {
    display: flex;
    gap: 0.75rem;
    align-items: center;
}

.truck-model {
    font-size: 0.8rem;
    color: #e2e8f0;
}

.truck-plate {
    font-size: 0.8rem;
    color: #9CA3AF;
    font-family: monospace;
    background: rgba(17, 24, 39, 0.5);
    padding: 0.1rem 0.4rem;
    border-radius: 4px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.truck-team {
    font-size: 0.9rem;
    color: #e2e8f0;
    margin-bottom: 1.5rem;
}

.truck-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.metric-item {
    background: rgba(17, 24, 39, 0.5);
    padding: 1rem;
    border-radius: 6px;
    border: 1px solid rgba(167, 139, 250, 0.2);
}

.metric-item.revenue {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.metric-item.profit {
    background: rgba(16, 185, 129, 0.15);
    border: 1px solid rgba(16, 185, 129, 0.25);
}

.metric-item.loss {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.metric-label {
    font-size: 0.8rem;
    color: #9CA3AF;
    margin-bottom: 0.5rem;
}

.metric-value {
    font-size: 1.1rem;
    font-weight: 500;
}

.metric-item.revenue .metric-value,
.metric-item.profit .metric-value {
    color: #10B981;
}

.metric-item.loss .metric-value {
    color: #EF4444;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-buttons .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sort-controls {
    display: flex;
    align-items: center;
}

.sort-controls .btn-group {
    margin-left: 0.5rem;
}

.sort-controls .btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
}

.sort-controls .btn i {
    font-size: 0.8rem;
}

.sort-controls .btn.active {
    background: rgba(167, 139, 250, 0.2);
    border-color: rgba(167, 139, 250, 0.5);
}

.metric-subtitle {
    color: #a78bfa;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(167, 139, 250, 0.2);
}

.employee-wage {
    font-size: 0.9rem;
    padding: 0.25rem 0;
    border-left: 2px solid rgba(167, 139, 250, 0.2);
    padding-left: 0.5rem;
}

.total-wages {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    font-weight: 500;
}

.total-expenses {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(167, 139, 250, 0.2);
    font-weight: 600;
    color: #ef4444;
}

.metric-card {
    padding: 1.25rem;
}
</style>

{% block scripts %}
<script>
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
    }).format(amount);
}

function formatNumber(num) {
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

let currentTrucks = [];

function calculateTotalExpenses(truck) {
    const monthlyExpenses = (
        parseFloat(truck.loan_payment || 0) +
        parseFloat(truck.insurance || 0) +
        parseFloat(truck.fuel_budget || 0) +
        parseFloat(truck.maintenance_budget || 0) +
        parseFloat(truck.other_expenses || 0)
    );
    
    // Calculate crew wages
    const crewWages = truck.employees ? truck.employees.reduce((total, emp) => {
        return total + (parseFloat(emp.hourly_wage || 0) * parseFloat(emp.hours_per_week || 0) * 4);
    }, 0) : 0;
    
    return monthlyExpenses + crewWages;
}

function calculateMonthlyRevenue(truck, efficiencyRate, hourlyRate) {
    const weeklyHours = truck.effective_hours || 
        (truck.employees ? truck.employees.reduce((total, emp) => total + parseFloat(emp.hours_per_week || 0), 0) : 0);
    const monthlyBillableHours = weeklyHours * 4 * efficiencyRate;
    return monthlyBillableHours * hourlyRate;
}

function calculateRevenue(truck, efficiencyRate, hourlyRate) {
    return calculateMonthlyRevenue(truck, efficiencyRate, hourlyRate);
}

function calculateProfit(truck, efficiencyRate, hourlyRate) {
    const revenue = calculateMonthlyRevenue(truck, efficiencyRate, hourlyRate);
    const expenses = calculateTotalExpenses(truck);
    return revenue - expenses;
}

function sortTrucks(by) {
    currentTrucks.sort((a, b) => {
        switch(by) {
            case 'name':
                return a.name.localeCompare(b.name);
            
            case 'revenue': {
                const revenueA = calculateMonthlyRevenue(a, window.efficiencyRate, window.hourlyRate);
                const revenueB = calculateMonthlyRevenue(b, window.efficiencyRate, window.hourlyRate);
                return revenueB - revenueA;
            }
            
            case 'profit': {
                const profitA = calculateProfit(a, window.efficiencyRate, window.hourlyRate);
                const profitB = calculateProfit(b, window.efficiencyRate, window.hourlyRate);
                return profitB - profitA;
            }
            
            case 'expenses': {
                const expensesA = calculateTotalExpenses(a);
                const expensesB = calculateTotalExpenses(b);
                return expensesB - expensesA;
            }
            
            case 'team': {
                const teamA = a.employees ? a.employees.length : 0;
                const teamB = b.employees ? b.employees.length : 0;
                return teamB - teamA;
            }
            
            default:
                return 0;
        }
    });
    
    renderTrucks(window.efficiencyRate, window.hourlyRate);
}

function loadTrucks() {
    Promise.all([
        fetch('/get_trucks').then(response => response.json()),
        fetch('/get_employees').then(response => response.json()),
        fetch('/get_dashboard_data').then(response => response.json())
    ]).then(([truckData, employeeData, dashData]) => {
        if (!truckData.success || !employeeData.success) {
            showNotification('Failed to load data', 'error');
            return;
        }
        
        console.log('Truck data:', truckData);
        console.log('Employee data:', employeeData);
        
        // Create a map of employees by ID for quick lookup
        const employeesById = {};
        employeeData.employees.forEach(emp => {
            employeesById[emp.employee_id] = emp;
        });
        
        console.log('Employees by ID:', employeesById);
        
        // Add employee objects to each truck
        currentTrucks = truckData.trucks.map(truck => {
            console.log('Processing truck:', truck);
            // The employees should already be attached from the backend
            if (!truck.employees) {
                truck.employees = [];
            }
            console.log('Truck employees:', truck.employees);
            return truck;
        });
        
        console.log('Processed trucks:', currentTrucks);
        
        window.efficiencyRate = dashData.business_parameters.efficiency_rate;
        window.hourlyRate = parseFloat(dashData.metrics.hourly_rate.replace(/[^0-9.]/g, ''));
        window.profitMargin = 1 - dashData.business_parameters.profit_margin_multiplier;
        
        // Populate employee select in the form
        const employeeSelect = document.getElementById('truckEmployees');
        if (employeeSelect) {
            employeeSelect.innerHTML = employeeData.employees.map(emp => 
                `<option value="${emp.employee_id}">${emp.name} (${emp.position})</option>`
            ).join('');
        }

        renderTrucks(window.efficiencyRate, window.hourlyRate);
    }).catch(error => {
        console.error('Error loading data:', error);
        showNotification('Failed to load data: ' + error.message, 'error');
    });
}

function renderTrucks(efficiencyRate, hourlyRate) {
    const truckContainer = document.getElementById('truckContainer');
    if (!truckContainer) return;

    truckContainer.innerHTML = currentTrucks.map(truck => {
        const monthlyExpenses = calculateTotalExpenses(truck);
        const monthlyRevenue = calculateMonthlyRevenue(truck, efficiencyRate, hourlyRate);
        const monthlyProfit = monthlyRevenue - monthlyExpenses;
        const profitMargin = monthlyRevenue > 0 ? (monthlyProfit / monthlyRevenue) * 100 : 0;

        return `
            <div class="truck-profile">
                <div class="truck-header">
                    <div class="truck-title">
                        <h4>${truck.name}</h4>
                        <div class="truck-subtitle">
                            <span class="model-badge">${truck.make} ${truck.model} ${truck.year}</span>
                            <span class="plate-badge">${truck.license_plate || ''}</span>
                            <span class="area-badge">${truck.service_area || 'Not specified'}</span>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary" onclick="editTruck('${truck.truck_id}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTruck('${truck.truck_id}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>

                <div class="truck-content">
                    <div class="content-section team-section">
                        <h6 class="section-title">Team Members</h6>
                        <div class="team-grid">
                            ${truck.employees && truck.employees.length > 0 ? truck.employees.map(emp => `
                                <div class="employee-card">
                                    <div class="employee-name">${emp.name || 'Unknown'}</div>
                                    <div class="employee-position">${emp.position || 'No position'}</div>
                                    <div class="employee-stats">
                                        <div class="stat">
                                            <span class="stat-label">Rate:</span>
                                            <span class="stat-value">${formatCurrency(parseFloat(emp.hourly_wage || 0))}/hr</span>
                                        </div>
                                        <div class="stat">
                                            <span class="stat-label">Hours:</span>
                                            <span class="stat-value">${parseFloat(emp.hours_per_week || 0)}/week</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div class="no-employees">No team members assigned</div>'}
                        </div>
                    </div>

                    <div class="content-section expenses-section">
                        <h6 class="section-title">Monthly Expenses</h6>
                        <div class="expenses-info">
                            <div class="expense-item">
                                <span>Loan Payment</span>
                                <span>${formatCurrency(truck.loan_payment)}</span>
                            </div>
                            <div class="expense-item">
                                <span>Insurance</span>
                                <span>${formatCurrency(truck.insurance)}</span>
                            </div>
                            <div class="expense-item">
                                <span>Fuel Budget</span>
                                <span>${formatCurrency(truck.fuel_budget)}</span>
                            </div>
                            <div class="expense-item">
                                <span>Maintenance Budget</span>
                                <span>${formatCurrency(truck.maintenance_budget)}</span>
                            </div>
                            <div class="expense-item">
                                <span>Other Expenses</span>
                                <span>${formatCurrency(truck.other_expenses)}</span>
                            </div>
                            <div class="expense-subtotal">
                                <span>Fixed Expenses</span>
                                <span>${formatCurrency(
                                    parseFloat(truck.loan_payment || 0) +
                                    parseFloat(truck.insurance || 0) +
                                    parseFloat(truck.fuel_budget || 0) +
                                    parseFloat(truck.maintenance_budget || 0) +
                                    parseFloat(truck.other_expenses || 0)
                                )}</span>
                            </div>
                            <div class="expense-subtotal">
                                <span>Team Wages</span>
                                <span>${formatCurrency(truck.employees ? truck.employees.reduce((total, emp) => 
                                    total + (parseFloat(emp.hourly_wage || 0) * parseFloat(emp.hours_per_week || 0) * 4), 0) : 0
                                )}</span>
                            </div>
                            <div class="expense-total">
                                <span>Total Monthly Expenses</span>
                                <span>${formatCurrency(monthlyExpenses)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="content-section metrics-section">
                        <h6 class="section-title">Monthly Performance</h6>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <h6 class="metric-subtitle">Hours & Efficiency</h6>
                                <div class="metric-content">
                                    <div class="metric-row">
                                        <span class="metric-label">Weekly Hours</span>
                                        <span class="metric-value">${formatNumber(truck.effective_hours || 
                                            (truck.employees ? truck.employees.reduce((total, emp) => 
                                                total + parseFloat(emp.hours_per_week || 0), 0) : 0))}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Monthly Hours</span>
                                        <span class="metric-value">${formatNumber((truck.effective_hours || 
                                            (truck.employees ? truck.employees.reduce((total, emp) => 
                                                total + parseFloat(emp.hours_per_week || 0), 0) : 0)) * 4)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Billable Hours</span>
                                        <span class="metric-value">${formatNumber((truck.effective_hours || 
                                            (truck.employees ? truck.employees.reduce((total, emp) => 
                                                total + parseFloat(emp.hours_per_week || 0), 0) : 0)) * 4 * efficiencyRate)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="metric-card">
                                <h6 class="metric-subtitle">Monthly Expenses</h6>
                                <div class="metric-content">
                                    <div class="metric-row">
                                        <span class="metric-label">Fixed Expenses</span>
                                        <span class="metric-value">${formatCurrency(
                                            parseFloat(truck.loan_payment || 0) +
                                            parseFloat(truck.insurance || 0) +
                                            parseFloat(truck.fuel_budget || 0) +
                                            parseFloat(truck.maintenance_budget || 0) +
                                            parseFloat(truck.other_expenses || 0)
                                        )}</span>
                                    </div>
                                    ${truck.employees && truck.employees.length > 0 ? truck.employees.map(emp => `
                                        <div class="metric-row employee-wage">
                                            <span class="metric-label">${emp.name} (${emp.position})</span>
                                            <span class="metric-value">${formatCurrency(parseFloat(emp.hourly_wage || 0) * parseFloat(emp.hours_per_week || 0) * 4)}</span>
                                        </div>
                                    `).join('') : ''}
                                    <div class="metric-row total-wages">
                                        <span class="metric-label">Total Wages</span>
                                        <span class="metric-value">${formatCurrency(truck.employees ? truck.employees.reduce((total, emp) => 
                                            total + (parseFloat(emp.hourly_wage || 0) * parseFloat(emp.hours_per_week || 0) * 4), 0) : 0
                                        )}</span>
                                    </div>
                                    <div class="metric-row total-expenses">
                                        <span class="metric-label">Total Expenses</span>
                                        <span class="metric-value">${formatCurrency(monthlyExpenses)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="metric-card">
                                <h6 class="metric-subtitle">Revenue & Profit</h6>
                                <div class="metric-content">
                                    <div class="metric-row">
                                        <span class="metric-label">Revenue</span>
                                        <span class="metric-value revenue">${formatCurrency(monthlyRevenue)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Expenses</span>
                                        <span class="metric-value">${formatCurrency(monthlyExpenses)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Profit</span>
                                        <span class="metric-value ${monthlyProfit >= 0 ? 'profit' : 'loss'}">${formatCurrency(monthlyProfit)}</span>
                                    </div>
                                    <div class="metric-row">
                                        <span class="metric-label">Margin</span>
                                        <span class="metric-value ${monthlyProfit >= 0 ? 'profit' : 'loss'}">${profitMargin.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function showAddTruckModal() {
    const modal = document.getElementById('truckModal');
    const form = document.getElementById('truckForm');
    form.reset();
    document.getElementById('truckId').value = '';
    modal.querySelector('.modal-title').textContent = 'Add New Truck';
    new bootstrap.Modal(modal).show();
}

function editTruck(truckId) {
    fetch(`/get_truck/${truckId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                showNotification('Failed to load truck data', 'error');
                return;
            }
            
            const truck = data.truck;
            const modal = document.getElementById('truckModal');
            modal.querySelector('.modal-title').textContent = 'Edit Truck';
            
            document.getElementById('truckId').value = truck.truck_id;
            document.getElementById('truckName').value = truck.name;
            document.getElementById('truckMake').value = truck.make || '';
            document.getElementById('truckModel').value = truck.model || '';
            document.getElementById('truckYear').value = truck.year || '';
            document.getElementById('truckLicense').value = truck.license_plate || '';
            document.getElementById('truckLoanPayment').value = truck.loan_payment || '';
            document.getElementById('truckInsurance').value = truck.insurance || '';
            document.getElementById('truckFuelBudget').value = truck.fuel_budget || '';
            document.getElementById('truckMaintenanceBudget').value = truck.maintenance_budget || '';
            document.getElementById('truckOtherExpenses').value = truck.other_expenses || '';
            document.getElementById('truckEffectiveHours').value = truck.effective_hours || '';
            document.getElementById('truckServiceArea').value = truck.service_area || '';
            document.getElementById('truckNotes').value = truck.notes || '';
            
            // Set selected employees
            const employeeSelect = document.getElementById('truckEmployees');
            if (employeeSelect) {
                Array.from(employeeSelect.options).forEach(option => {
                    option.selected = (truck.employee_ids || []).includes(option.value);
                });
            }
            
            new bootstrap.Modal(modal).show();
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to load truck data: ' + error.message, 'error');
        });
}

function deleteTruck(truckId) {
    if (confirm('Are you sure you want to delete this truck? This will affect your business calculations.')) {
        fetch(`/delete_truck/${truckId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadTrucks();
                showNotification('Truck deleted successfully');
            } else {
                showNotification('Failed to delete truck: ' + (data.error || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to delete truck: ' + error.message, 'error');
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadTrucks();
    
    document.getElementById('truckForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const employeeSelect = document.getElementById('truckEmployees');
        const selectedEmployees = Array.from(employeeSelect.selectedOptions).map(option => option.value);
        
        const data = {
            truck_id: formData.get('truck_id'),
            name: formData.get('name'),
            make: formData.get('make'),
            model: formData.get('model'),
            year: formData.get('year'),
            license_plate: formData.get('license_plate'),
            loan_payment: formData.get('loan_payment') ? parseFloat(formData.get('loan_payment')) : 0,
            insurance: formData.get('insurance') ? parseFloat(formData.get('insurance')) : 0,
            fuel_budget: formData.get('fuel_budget') ? parseFloat(formData.get('fuel_budget')) : 0,
            maintenance_budget: formData.get('maintenance_budget') ? parseFloat(formData.get('maintenance_budget')) : 0,
            other_expenses: formData.get('other_expenses') ? parseFloat(formData.get('other_expenses')) : 0,
            employee_ids: selectedEmployees,
            effective_hours: formData.get('effective_hours') && formData.get('effective_hours').trim() !== '' ? 
                           parseFloat(formData.get('effective_hours')) : null,
            service_area: formData.get('service_area'),
            notes: formData.get('notes')
        };
        
        const isEdit = data.truck_id;
        fetch(isEdit ? `/update_truck/${data.truck_id}` : '/add_truck', {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('truckModal')).hide();
                loadTrucks();
                showNotification(`Truck ${isEdit ? 'updated' : 'added'} successfully`);
            } else {
                showNotification(data.error || 'Failed to save truck', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Failed to save truck: ' + error.message, 'error');
        });
    });
});
</script>
{% endblock %}
{% endblock %} 